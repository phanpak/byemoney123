---
interface Props {
  currentCategory?: string;
}

const { currentCategory = 'all' } = Astro.props;

const categories = [
  { id: 'all', label: 'All', count: '18' },
  { id: 'tech', label: 'Tech', count: '03' },
  { id: 'home', label: 'Home', count: '06' },
  { id: 'outfit', label: 'Outfit', count: '03' },
  { id: 'motors', label: 'Motors', count: '01' },
  { id: 'culture', label: 'Culture', count: '01' },
  { id: 'grooming', label: 'Grooming', count: '01' },
  { id: 'outdoor', label: 'Outdoor', count: '01' },
  { id: 'office', label: 'Office', count: '01' },
];

const menuLinks = [
  { href: './', label: 'Home' },
  { href: './about', label: 'About' },
  { href: './index', label: 'Index' },
  { href: './contact', label: 'Contact' },
];
---

<header class="header" data-header>
  <!-- Left: Logo -->
  <div class="header-left">
    <a href="./" class="logo" data-magnetic>
      <div class="logo-icon">
        <svg viewBox="0 0 40 40" fill="none">
          <circle cx="20" cy="20" r="19" stroke="currentColor" stroke-width="1.5"/>
          <path d="M14 20h12M20 14v12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
        <div class="logo-glow"></div>
      </div>
      <span class="logo-text">bye money</span>
    </a>
  </div>

  <!-- Center: Filter Pills -->
  <nav class="filter-nav" data-filter-nav>
    <div class="filter-track">
      {categories.map((cat, i) => (
        <button
          class:list={['filter-pill', { active: cat.id === currentCategory }]}
          data-category={cat.id}
          style={`--i: ${i}`}
        >
          <span class="filter-label">{cat.label}</span>
          <span class="filter-count">{cat.count}</span>
        </button>
      ))}
    </div>
    <div class="filter-indicator"></div>
  </nav>

  <!-- Right: Theme Toggle & Menu -->
  <div class="header-right">
    <button class="theme-toggle" data-theme-toggle aria-label="Toggle theme" data-magnetic>
      <span class="theme-toggle-icon theme-toggle-icon--sun">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <circle cx="12" cy="12" r="5"/>
          <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
        </svg>
      </span>
      <span class="theme-toggle-icon theme-toggle-icon--moon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>
        </svg>
      </span>
    </button>
    <button class="menu-trigger" data-menu-trigger aria-expanded="false" data-magnetic>
      <span class="menu-text">Menu</span>
      <div class="menu-icon">
        <span></span>
        <span></span>
      </div>
    </button>
  </div>
</header>

<!-- Full-screen menu overlay -->
<div class="menu-overlay" data-menu-overlay>
  <div class="menu-backdrop"></div>
  <div class="menu-content">
    <nav class="menu-nav">
      {menuLinks.map((link, i) => (
        <a href={link.href} class="menu-link" style={`--link-i: ${i}`} data-magnetic>
          <span class="menu-link-index">0{i + 1}</span>
          <span class="menu-link-text">
            {link.label.split('').map((char, charIndex) => (
              <span class="menu-char" style={`--char-i: ${charIndex}`}>{char}</span>
            ))}
          </span>
          <span class="menu-link-arrow">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
              <path d="M7 17L17 7M17 7H7M17 7V17" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </span>
        </a>
      ))}
    </nav>
    <div class="menu-footer">
      <p class="menu-tagline">Obsessively Curated</p>
    </div>
  </div>
</div>

<style>
  .header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.25rem 2rem;
    mix-blend-mode: difference;
  }

  /* Remove mix-blend-mode in light theme for better readability */
  :global([data-theme="light"]) .header {
    mix-blend-mode: normal;
  }

  /* When scrolled, disable mix-blend-mode so elements stay readable */
  .header.scrolled {
    mix-blend-mode: normal;
  }

  /* Logo */
  .header-left {
    flex: 1;
  }

  .logo {
    display: inline-flex;
    align-items: center;
    gap: 0.75rem;
    color: var(--color-cream);
  }

  .logo-icon {
    position: relative;
    width: 40px;
    height: 40px;
    color: currentColor;
  }

  .logo-icon svg {
    width: 100%;
    height: 100%;
    transition: transform 0.6s var(--ease-out-expo);
  }

  .logo:hover .logo-icon svg {
    transform: rotate(90deg);
  }

  .logo-glow {
    position: absolute;
    inset: -10px;
    background: radial-gradient(circle, var(--color-gold-muted) 0%, transparent 70%);
    opacity: 0;
    transition: opacity 0.4s ease;
    /* Subtle heartbeat pulse when idle */
    animation: logoPulse 3s ease-in-out infinite;
  }

  @keyframes logoPulse {
    0%, 100% { opacity: 0.15; transform: scale(1); }
    50% { opacity: 0.3; transform: scale(1.1); }
  }

  .logo:hover .logo-glow {
    opacity: 1;
    animation: none;
  }

  .logo-text {
    font-family: var(--font-display);
    font-size: 1rem;
    font-weight: 500;
    letter-spacing: -0.02em;
    opacity: 0;
    transform: translateX(-10px);
    transition: opacity 0.4s ease, transform 0.4s var(--ease-out-expo);
  }

  .logo:hover .logo-text {
    opacity: 1;
    transform: translateX(0);
  }

  /* Filter Navigation */
  .filter-nav {
    position: relative;
    flex: 2;
    display: flex;
    justify-content: center;
  }

  .filter-track {
    display: flex;
    gap: 0.25rem;
    padding: 0.25rem;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.06);
    border-radius: var(--radius-full);
    backdrop-filter: blur(20px);
  }

  :global([data-theme="light"]) .filter-track {
    background: rgba(0, 0, 0, 0.03);
    border-color: rgba(0, 0, 0, 0.08);
  }

  .filter-pill {
    position: relative;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 1rem;
    color: var(--color-cream);
    font-family: var(--font-body);
    font-size: 0.8125rem;
    font-weight: 500;
    border-radius: var(--radius-full);
    transition: all 0.3s var(--ease-out-expo);
    overflow: hidden;
  }

  .filter-pill::before {
    content: '';
    position: absolute;
    inset: 0;
    background: var(--color-cream);
    border-radius: inherit;
    transform: scaleX(0);
    transform-origin: left;
    transition: transform 0.4s var(--ease-out-expo);
  }

  .filter-pill:hover::before,
  .filter-pill.active::before {
    transform: scaleX(1);
  }

  :global([data-theme="light"]) .filter-pill::before {
    background: #1a1a1a;
  }

  .filter-label {
    position: relative;
    z-index: 1;
    transition: color 0.3s ease;
  }

  .filter-pill:hover .filter-label,
  .filter-pill.active .filter-label {
    color: var(--color-bg);
  }

  :global([data-theme="light"]) .filter-pill:hover .filter-label,
  :global([data-theme="light"]) .filter-pill.active .filter-label {
    color: #f8f6f3;
  }

  .filter-count {
    position: relative;
    z-index: 1;
    font-family: var(--font-display);
    font-size: 0.625rem;
    opacity: 0.5;
    transition: color 0.3s ease, opacity 0.3s ease;
  }

  .filter-pill:hover .filter-count,
  .filter-pill.active .filter-count {
    color: var(--color-bg);
    opacity: 0.7;
  }

  /* Sliding Filter Indicator */
  .filter-indicator {
    position: absolute;
    bottom: -2px;
    left: 0;
    height: 2px;
    background: linear-gradient(90deg, var(--color-gold), var(--color-gold-light));
    border-radius: var(--radius-full);
    pointer-events: none;
    z-index: 10;
    box-shadow: 0 0 10px var(--color-gold), 0 0 20px rgba(201, 162, 39, 0.3);
    transition: left 0.4s var(--ease-out-expo), width 0.4s var(--ease-out-expo);
  }

  /* Theme Toggle */
  .header-right {
    flex: 1;
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
  }

  .theme-toggle {
    position: relative;
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-cream);
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 50%;
    backdrop-filter: blur(20px);
    transition: all 0.4s var(--ease-out-expo);
    overflow: hidden;
  }

  .theme-toggle:hover {
    background: rgba(255, 255, 255, 0.08);
    border-color: rgba(255, 255, 255, 0.15);
    transform: rotate(15deg);
  }

  :global([data-theme="light"]) .theme-toggle {
    background: rgba(0, 0, 0, 0.03);
    border-color: rgba(0, 0, 0, 0.08);
  }

  :global([data-theme="light"]) .theme-toggle:hover {
    background: rgba(0, 0, 0, 0.06);
    border-color: rgba(0, 0, 0, 0.12);
  }

  .theme-toggle-icon {
    position: absolute;
    width: 20px;
    height: 20px;
    transition: all 0.5s var(--ease-out-expo);
  }

  .theme-toggle-icon svg {
    width: 100%;
    height: 100%;
  }

  /* Dark mode (default): show moon, hide sun */
  .theme-toggle-icon--sun {
    opacity: 0;
    transform: rotate(-90deg) scale(0.5);
  }

  .theme-toggle-icon--moon {
    opacity: 1;
    transform: rotate(0) scale(1);
  }

  /* Light mode: show sun, hide moon */
  [data-theme="light"] .theme-toggle-icon--sun {
    opacity: 1;
    transform: rotate(0) scale(1);
  }

  [data-theme="light"] .theme-toggle-icon--moon {
    opacity: 0;
    transform: rotate(90deg) scale(0.5);
  }

  /* Menu Trigger */

  .menu-trigger {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1.25rem;
    color: var(--color-cream);
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: var(--radius-full);
    backdrop-filter: blur(20px);
    transition: all 0.3s var(--ease-out-expo);
  }

  .menu-trigger:hover {
    background: rgba(255, 255, 255, 0.08);
    border-color: rgba(255, 255, 255, 0.15);
  }

  :global([data-theme="light"]) .menu-trigger {
    background: rgba(0, 0, 0, 0.03);
    border-color: rgba(0, 0, 0, 0.08);
  }

  :global([data-theme="light"]) .menu-trigger:hover {
    background: rgba(0, 0, 0, 0.06);
    border-color: rgba(0, 0, 0, 0.12);
  }

  .menu-text {
    font-family: var(--font-body);
    font-size: 0.875rem;
    font-weight: 500;
  }

  .menu-icon {
    position: relative;
    width: 18px;
    height: 12px;
  }

  .menu-icon span {
    position: absolute;
    left: 0;
    width: 100%;
    height: 1.5px;
    background: currentColor;
    transition: all 0.3s var(--ease-out-expo);
  }

  .menu-icon span:first-child {
    top: 0;
  }

  .menu-icon span:last-child {
    bottom: 0;
  }

  .menu-trigger[aria-expanded="true"] .menu-icon span:first-child {
    top: 50%;
    transform: translateY(-50%) rotate(45deg);
  }

  .menu-trigger[aria-expanded="true"] .menu-icon span:last-child {
    bottom: 50%;
    transform: translateY(50%) rotate(-45deg);
  }

  /* Menu Overlay */
  .menu-overlay {
    position: fixed;
    inset: 0;
    z-index: 999;
    pointer-events: none;
    opacity: 0;
    visibility: hidden;
  }

  .menu-overlay.open {
    pointer-events: all;
    opacity: 1;
    visibility: visible;
  }

  .menu-backdrop {
    position: absolute;
    inset: 0;
    background: var(--color-bg);
    opacity: 0;
    backdrop-filter: blur(0px) saturate(1);
    -webkit-backdrop-filter: blur(0px) saturate(1);
    transition:
      opacity 0.6s var(--ease-out-expo),
      backdrop-filter 0.8s var(--ease-out-expo),
      -webkit-backdrop-filter 0.8s var(--ease-out-expo);
  }

  .menu-overlay.open .menu-backdrop {
    opacity: 0.95;
    backdrop-filter: blur(30px) saturate(0.7);
    -webkit-backdrop-filter: blur(30px) saturate(0.7);
  }

  :global([data-theme="light"]) .menu-overlay.open .menu-backdrop {
    opacity: 0.97;
  }

  .menu-content {
    position: relative;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    padding: 6rem 4rem;
  }

  .menu-nav {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .menu-link {
    display: flex;
    align-items: center;
    gap: 2rem;
    padding: 1.5rem 0;
    color: var(--color-cream);
    border-bottom: 1px solid rgba(245, 240, 232, 0.06);
    transition: padding 0.6s var(--ease-out-expo);
  }

  :global([data-theme="light"]) .menu-link {
    border-bottom-color: rgba(26, 26, 26, 0.1);
  }

  .menu-link:hover {
    padding-left: 1rem;
  }

  .menu-link-index {
    font-family: var(--font-display);
    font-size: 0.875rem;
    color: var(--color-gold);
    opacity: 0;
    transform: translateX(-20px);
    transition: all 0.5s var(--ease-out-expo);
    transition-delay: calc(var(--link-i) * 0.1s + 0.2s);
  }

  .menu-overlay.open .menu-link-index {
    opacity: 0.6;
    transform: translateX(0);
  }

  .menu-link-text {
    font-family: var(--font-display);
    font-size: clamp(2.5rem, 6vw, 5rem);
    font-weight: 500;
    letter-spacing: -0.03em;
    flex: 1;
    overflow: hidden;
    perspective: 1000px;
  }

  /* Theatrical split-char animation */
  .menu-char {
    display: inline-block;
    transform: translateY(120%) rotateX(-80deg);
    transform-origin: center bottom;
    opacity: 0;
    transition: all 0.6s var(--ease-out-expo);
    transition-delay: calc(var(--link-i) * 0.1s + var(--char-i) * 0.03s);
    transform-style: preserve-3d;
  }

  .menu-overlay.open .menu-char {
    transform: translateY(0) rotateX(0);
    opacity: 1;
  }

  /* Hover effect - chars lift and glow */
  .menu-link:hover .menu-char {
    color: var(--color-gold);
    transform: translateY(-4px) rotateX(0);
    transition-delay: calc(var(--char-i) * 0.015s);
    text-shadow: 0 4px 20px rgba(201, 162, 39, 0.3);
  }

  /* Stagger hover effect for more drama */
  .menu-link:hover .menu-char:nth-child(odd) {
    transform: translateY(-6px) rotateX(0);
  }

  .menu-link-arrow {
    opacity: 0;
    transform: translate(-20px, 20px) rotate(-45deg);
    transition: all 0.5s var(--ease-out-expo);
    transition-delay: calc(var(--link-i) * 0.1s + 0.4s);
  }

  .menu-overlay.open .menu-link-arrow {
    opacity: 0.3;
    transform: translate(0, 0) rotate(0);
  }

  .menu-link:hover .menu-link-arrow {
    opacity: 1;
    transform: translate(5px, -5px) rotate(0);
    color: var(--color-gold);
  }

  .menu-footer {
    position: absolute;
    bottom: 3rem;
    left: 4rem;
    right: 4rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.6s var(--ease-out-expo);
    transition-delay: 0.4s;
  }

  .menu-overlay.open .menu-footer {
    opacity: 1;
    transform: translateY(0);
  }

  .menu-tagline {
    font-family: var(--font-body);
    font-size: 0.875rem;
    color: var(--color-text-muted);
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .filter-nav {
      display: none;
    }
  }

  @media (max-width: 768px) {
    .header {
      padding: 1rem 1.5rem;
    }

    .logo-text {
      display: none;
    }

    .menu-content {
      padding: 5rem 2rem;
    }

    .menu-link {
      gap: 1rem;
    }

    .menu-footer {
      left: 2rem;
      right: 2rem;
    }
  }
</style>

<script>
  // Move menu overlay to body to ensure fixed positioning works
  const menuOverlay = document.querySelector('[data-menu-overlay]');
  if (menuOverlay) {
    document.body.appendChild(menuOverlay);
  }

  // Theme toggle
  const themeToggle = document.querySelector('[data-theme-toggle]');
  const html = document.documentElement;

  // Check for saved theme or system preference
  const getPreferredTheme = () => {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) return savedTheme;

    return window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
  };

  // Apply theme
  const applyTheme = (theme: string) => {
    if (theme === 'light') {
      html.setAttribute('data-theme', 'light');
    } else {
      html.removeAttribute('data-theme');
    }
    localStorage.setItem('theme', theme);
  };

  // Initialize theme
  applyTheme(getPreferredTheme());

  // Toggle theme on click
  themeToggle?.addEventListener('click', () => {
    const currentTheme = html.getAttribute('data-theme');
    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
    applyTheme(newTheme);
  });

  // Listen for system theme changes
  window.matchMedia('(prefers-color-scheme: light)').addEventListener('change', (e) => {
    if (!localStorage.getItem('theme')) {
      applyTheme(e.matches ? 'light' : 'dark');
    }
  });

  // Menu toggle (menuOverlay already declared at top of script)
  const menuTrigger = document.querySelector('[data-menu-trigger]');

  menuTrigger?.addEventListener('click', () => {
    const isOpen = menuOverlay?.classList.toggle('open');
    menuTrigger.setAttribute('aria-expanded', String(isOpen));
    document.body.style.overflow = isOpen ? 'hidden' : '';
  });

  // Close menu on link click
  const menuLinks = document.querySelectorAll('.menu-link');
  menuLinks.forEach(link => {
    link.addEventListener('click', () => {
      menuOverlay?.classList.remove('open');
      menuTrigger?.setAttribute('aria-expanded', 'false');
      document.body.style.overflow = '';
    });
  });

  // Filter functionality with sliding indicator
  const filterPills = document.querySelectorAll('.filter-pill');
  const filterIndicator = document.querySelector('.filter-indicator') as HTMLElement;
  const filterTrack = document.querySelector('.filter-track') as HTMLElement;

  // Position the sliding indicator under the active pill
  const updateIndicator = (activePill: Element | null) => {
    if (!activePill || !filterIndicator || !filterTrack) return;

    const pillRect = activePill.getBoundingClientRect();
    const trackRect = filterTrack.getBoundingClientRect();

    // Calculate position relative to the filter track
    const left = pillRect.left - trackRect.left;
    const width = pillRect.width;

    filterIndicator.style.width = `${width}px`;
    filterIndicator.style.left = `${left}px`;
    filterIndicator.style.opacity = '1';
  };

  // Initialize indicator position on load
  const initialActivePill = document.querySelector('.filter-pill.active');
  if (initialActivePill && filterIndicator) {
    // Set initial state without transition
    filterIndicator.style.transition = 'none';
    updateIndicator(initialActivePill);
    // Re-enable transition after a frame
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        filterIndicator.style.transition = '';
      });
    });
  }

  filterPills.forEach(pill => {
    pill.addEventListener('click', () => {
      const category = pill.getAttribute('data-category');

      // Update active state
      filterPills.forEach(p => p.classList.remove('active'));
      pill.classList.add('active');

      // Slide indicator to new position
      updateIndicator(pill);

      // Dispatch event
      document.dispatchEvent(new CustomEvent('categoryChange', { detail: { category } }));

      // Scroll to product grid to show filtered results
      const productGrid = document.querySelector('.product-grid');
      if (productGrid) {
        const headerHeight = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--header-height')) || 80;
        const gridTop = productGrid.getBoundingClientRect().top + window.scrollY;
        const scrollTarget = gridTop - headerHeight - 40; // 40px extra padding

        window.scrollTo({
          top: Math.max(0, scrollTarget),
          behavior: 'smooth'
        });
      }
    });
  });

  // Header scroll effect
  let lastScroll = 0;
  const header = document.querySelector('[data-header]');

  window.addEventListener('scroll', () => {
    const currentScroll = window.scrollY;

    if (currentScroll > 100) {
      header?.classList.add('scrolled');
    } else {
      header?.classList.remove('scrolled');
    }

    lastScroll = currentScroll;
  });
</script>
