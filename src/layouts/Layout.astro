---
import Cursor from '../components/Cursor.astro';

interface Props {
  title?: string;
}

const { title = 'bye money' } = Astro.props;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="bye money - Obsessively curated products for those who appreciate the finer things" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

    <!-- Preconnect for fonts -->
    <link rel="preconnect" href="https://api.fontshare.com" crossorigin />

    <title>{title}</title>

    <!-- Prevent flash of wrong theme -->
    <script is:inline>
      (function() {
        const savedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const theme = savedTheme || (prefersDark ? 'dark' : 'light');
        if (theme === 'light') {
          document.documentElement.setAttribute('data-theme', 'light');
        }
      })();
    </script>
  </head>
  <body>
    <!-- Cinematic Split Reveal Overlays -->
    <div class="reveal-top" id="reveal-top"></div>
    <div class="reveal-bottom" id="reveal-bottom"></div>

    <!-- Scroll Progress Bar -->
    <div class="scroll-progress" id="scroll-progress"></div>

    <!-- Preloader -->
    <div class="loader" id="loader">
      <div class="loader-inner">
        <div class="loader-text" id="loader-text" aria-hidden="true">
          <span style="--i: 0">b</span><span style="--i: 1">y</span><span style="--i: 2">e</span>
          <span class="loader-space"></span>
          <span style="--i: 3">m</span><span style="--i: 4">o</span><span style="--i: 5">n</span><span style="--i: 6">e</span><span style="--i: 7">y</span>
        </div>
        <div class="loader-line"></div>
      </div>
      <div class="loader-counter" id="loader-counter">0</div>
    </div>

    <!-- Particle Burst Container -->
    <div class="particle-container" id="particle-container" aria-hidden="true"></div>

    <!-- Ambient background effects -->
    <div class="ambient-bg" aria-hidden="true">
      <div class="gradient-orb gradient-orb--gold"></div>
      <div class="gradient-orb gradient-orb--cream"></div>
      <div class="noise-overlay"></div>
    </div>

    <!-- Custom cursor -->
    <Cursor />

    <!-- Page content -->
    <div class="page-wrapper" id="page-wrapper">
      <slot />
    </div>

    <!-- GSAP for premium animations -->
    <script is:inline src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script is:inline src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js"></script>

    <script is:inline>
      // Register GSAP plugins
      gsap.registerPlugin(ScrollTrigger);

      // Elements
      var loader = document.getElementById('loader');
      var loaderText = document.getElementById('loader-text');
      var counter = document.getElementById('loader-counter');
      var pageWrapper = document.getElementById('page-wrapper');
      var revealTop = document.getElementById('reveal-top');
      var revealBottom = document.getElementById('reveal-bottom');
      var particleContainer = document.getElementById('particle-container');
      var scrollProgress = document.getElementById('scroll-progress');

      // Spawn particle burst effect
      function spawnParticleBurst() {
        var particleCount = 30;
        for (var i = 0; i < particleCount; i++) {
          var particle = document.createElement('div');
          particle.className = 'burst-particle';

          // Random position from center
          var angle = (Math.PI * 2 * i) / particleCount + Math.random() * 0.5;
          var distance = 100 + Math.random() * 200;
          var x = Math.cos(angle) * distance;
          var y = Math.sin(angle) * distance;

          particle.style.setProperty('--x', x + 'px');
          particle.style.setProperty('--y', y + 'px');
          particle.style.setProperty('--delay', (Math.random() * 0.3) + 's');
          particle.style.setProperty('--size', (3 + Math.random() * 4) + 'px');

          particleContainer.appendChild(particle);

          // Remove after animation
          setTimeout(function() { particle.remove(); }, 1500);
        }
      }

      // Cinematic GSAP Timeline
      var masterTl = gsap.timeline();

      // Set initial states
      gsap.set(loaderText.querySelectorAll('span:not(.loader-space)'), { y: 60, opacity: 0, rotateX: -90 });
      gsap.set(pageWrapper, { opacity: 0, scale: 0.97 });
      gsap.set(revealTop, { yPercent: 0 });
      gsap.set(revealBottom, { yPercent: 0 });

      // Build the timeline
      masterTl
        // Phase 1: Text reveal with 3D rotation
        .to(loaderText.querySelectorAll('span:not(.loader-space)'), {
          y: 0,
          opacity: 1,
          rotateX: 0,
          duration: 0.8,
          stagger: 0.06,
          ease: 'back.out(1.7)'
        })
        // Phase 2: Counter animation (runs alongside)
        .to(counter, {
          textContent: 100,
          duration: 1.2,
          snap: { textContent: 1 },
          ease: 'power2.inOut'
        }, '<0.2')
        // Phase 3: Split reveal - curtains part
        .to(revealTop, {
          yPercent: -100,
          duration: 0.9,
          ease: 'power4.inOut'
        }, '+=0.4')
        .to(revealBottom, {
          yPercent: 100,
          duration: 0.9,
          ease: 'power4.inOut'
        }, '<')
        // Fade out loader content
        .to(loader, {
          opacity: 0,
          duration: 0.3
        }, '<0.3')
        // Phase 4: Page content reveals with scale
        .to(pageWrapper, {
          opacity: 1,
          scale: 1,
          duration: 0.8,
          ease: 'power2.out',
          onStart: function() {
            pageWrapper.classList.add('loaded');
          }
        }, '-=0.5')
        // Phase 5: Particle burst
        .add(function() {
          spawnParticleBurst();
        }, '-=0.6')
        // Cleanup
        .add(function() {
          loader.style.visibility = 'hidden';
          loader.style.pointerEvents = 'none';
          revealTop.style.visibility = 'hidden';
          revealBottom.style.visibility = 'hidden';
          initScrollAnimations();
          initScrollProgress();
        });

      // Scroll progress bar
      function initScrollProgress() {
        window.addEventListener('scroll', function() {
          var scrollTop = window.scrollY;
          var docHeight = document.documentElement.scrollHeight - window.innerHeight;
          var scrollPercent = (scrollTop / docHeight) * 100;
          scrollProgress.style.width = scrollPercent + '%';
        });
      }

      // Scroll animations initialization
      function initScrollAnimations() {
        // Animate elements with data-animate attribute
        var animateElements = document.querySelectorAll('[data-animate]');

        animateElements.forEach(function(el) {
          ScrollTrigger.create({
            trigger: el,
            start: 'top 85%',
            onEnter: function() { el.classList.add('is-visible'); },
            once: true
          });
        });

        // Stagger animations
        var staggerElements = document.querySelectorAll('[data-animate-stagger]');

        staggerElements.forEach(function(el) {
          ScrollTrigger.create({
            trigger: el,
            start: 'top 85%',
            onEnter: function() { el.classList.add('is-visible'); },
            once: true
          });
        });

        // SCROLL-LINKED CARD WATERFALL - Cards pour into view
        var cardElements = document.querySelectorAll('[data-card-scroll]');

        cardElements.forEach(function(card, i) {
          // Initial state for scroll-linked animation
          gsap.set(card, {
            opacity: 0,
            y: 80,
            rotateX: -5,
            scale: 0.95
          });

          gsap.to(card, {
            opacity: 1,
            y: 0,
            rotateX: 0,
            scale: 1,
            duration: 1,
            ease: 'power3.out',
            scrollTrigger: {
              trigger: card,
              start: 'top 90%',
              end: 'top 60%',
              scrub: 0.8,
              toggleActions: 'play none none reverse'
            }
          });

          // Image parallax within card
          var cardImage = card.querySelector('.card-image');
          if (cardImage) {
            gsap.to(cardImage, {
              y: -20,
              ease: 'none',
              scrollTrigger: {
                trigger: card,
                start: 'top bottom',
                end: 'bottom top',
                scrub: 1.5
              }
            });
          }
        });

        // Parallax effects
        var parallaxElements = document.querySelectorAll('[data-parallax]');

        parallaxElements.forEach(function(el) {
          var speed = parseFloat(el.getAttribute('data-parallax') || '0.5');

          gsap.to(el, {
            yPercent: -30 * speed,
            ease: 'none',
            scrollTrigger: {
              trigger: el,
              start: 'top bottom',
              end: 'bottom top',
              scrub: true
            }
          });
        });

        // Horizontal scroll text
        var marqueeTexts = document.querySelectorAll('[data-marquee]');

        marqueeTexts.forEach(function(el) {
          gsap.to(el, {
            xPercent: -50,
            ease: 'none',
            scrollTrigger: {
              trigger: el,
              start: 'top bottom',
              end: 'bottom top',
              scrub: 1
            }
          });
        });

        // SCROLL VELOCITY TEXT BLUR - Cinematic motion blur on fast scroll
        var lastScrollY = window.scrollY;
        var lastScrollTime = Date.now();
        var sectionTitles = document.querySelectorAll('.section-title, .section-title-line');

        window.addEventListener('scroll', function() {
          var now = Date.now();
          var dt = now - lastScrollTime;
          if (dt === 0) return;

          var velocity = Math.abs(window.scrollY - lastScrollY) / dt * 1000;
          var blurAmount = Math.min(velocity / 500, 3); // Max 3px blur

          sectionTitles.forEach(function(el) {
            if (velocity > 800) {
              el.style.filter = 'blur(' + blurAmount + 'px)';
              el.style.transition = 'filter 0.05s linear';
            } else {
              el.style.filter = 'blur(0)';
              el.style.transition = 'filter 0.2s ease-out';
            }
          });

          lastScrollY = window.scrollY;
          lastScrollTime = now;
        });
      }

      // Magnetic effect for interactive elements
      document.querySelectorAll('[data-magnetic]').forEach(function(el) {
        el.addEventListener('mousemove', function(e) {
          var rect = el.getBoundingClientRect();
          var x = e.clientX - rect.left - rect.width / 2;
          var y = e.clientY - rect.top - rect.height / 2;

          gsap.to(el, {
            x: x * 0.3,
            y: y * 0.3,
            duration: 0.3,
            ease: 'power2.out'
          });
        });

        el.addEventListener('mouseleave', function() {
          gsap.to(el, {
            x: 0,
            y: 0,
            duration: 0.5,
            ease: 'elastic.out(1, 0.3)'
          });
        });
      });
    </script>
  </body>
</html>

<style is:global>
  @import '../styles/global.css';

  /* Loader styles */
  .loader {
    position: fixed;
    inset: 0;
    background: var(--color-bg);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 2rem;
  }

  .loader.loaded {
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
    transition: opacity 0.8s var(--ease-out-expo), visibility 0.8s;
  }

  .loader-inner {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1.5rem;
  }

  .loader-text {
    font-family: var(--font-display);
    font-size: clamp(2.5rem, 6vw, 5rem);
    font-weight: 600;
    color: var(--color-cream);
    letter-spacing: -0.02em;
    display: flex;
    overflow: hidden;
  }

  .loader-text span {
    display: inline-block;
    animation: loaderCharReveal 0.8s var(--ease-out-expo) forwards;
    animation-delay: calc(var(--i) * 0.08s);
    opacity: 0;
    transform: translateY(100%);
  }

  .loader-space {
    width: 0.3em;
  }

  @keyframes loaderCharReveal {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .loader-line {
    width: 120px;
    height: 2px;
    background: var(--color-surface);
    border-radius: var(--radius-full);
    overflow: hidden;
    position: relative;
  }

  .loader-line::after {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
    width: 0;
    background: linear-gradient(90deg, var(--color-gold), var(--color-gold-light));
    animation: loaderLineProgress 1.2s var(--ease-out-expo) forwards;
  }

  @keyframes loaderLineProgress {
    to {
      width: 100%;
    }
  }

  .loader-counter {
    position: absolute;
    bottom: 8%;
    right: 8%;
    font-family: var(--font-display);
    font-size: clamp(4rem, 15vw, 12rem);
    font-weight: 600;
    color: var(--color-gold);
    opacity: 0.08;
    line-height: 1;
    letter-spacing: -0.05em;
  }

  /* Ambient background */
  .ambient-bg {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 0;
  }

  /* Page wrapper */
  .page-wrapper {
    position: relative;
    z-index: 1;
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 1s var(--ease-out-expo), transform 1s var(--ease-out-expo);
    transition-delay: 0.3s;
  }

  .page-wrapper.loaded {
    opacity: 1;
    transform: translateY(0);
  }

  /* Cinematic Split Reveal Overlays */
  .reveal-top,
  .reveal-bottom {
    position: fixed;
    left: 0;
    right: 0;
    height: 50vh;
    background: var(--color-bg);
    z-index: 10001;
    pointer-events: none;
  }

  .reveal-top {
    top: 0;
    /* Subtle gradient for depth */
    background: linear-gradient(to bottom, var(--color-bg) 0%, var(--color-bg) 80%, rgba(10, 10, 10, 0.95) 100%);
  }

  .reveal-bottom {
    bottom: 0;
    background: linear-gradient(to top, var(--color-bg) 0%, var(--color-bg) 80%, rgba(10, 10, 10, 0.95) 100%);
  }

  [data-theme="light"] .reveal-top {
    background: linear-gradient(to bottom, var(--color-bg) 0%, var(--color-bg) 80%, rgba(248, 246, 243, 0.95) 100%);
  }

  [data-theme="light"] .reveal-bottom {
    background: linear-gradient(to top, var(--color-bg) 0%, var(--color-bg) 80%, rgba(248, 246, 243, 0.95) 100%);
  }

  /* Scroll Progress Bar */
  .scroll-progress {
    position: fixed;
    top: 0;
    left: 0;
    height: 3px;
    width: 0;
    background: linear-gradient(90deg, var(--color-gold), var(--color-gold-light));
    z-index: 10002;
    box-shadow: 0 0 20px var(--color-gold), 0 0 40px rgba(201, 162, 39, 0.3);
    transition: width 0.1s ease-out;
  }

  /* Particle Container */
  .particle-container {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 10003;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* Burst Particles */
  .burst-particle {
    position: absolute;
    width: var(--size, 4px);
    height: var(--size, 4px);
    background: var(--color-gold);
    border-radius: 50%;
    animation: particleBurst 1.5s ease-out forwards;
    animation-delay: var(--delay, 0s);
    box-shadow: 0 0 6px var(--color-gold);
  }

  @keyframes particleBurst {
    0% {
      transform: translate(0, 0) scale(1);
      opacity: 1;
    }
    100% {
      transform: translate(var(--x), var(--y)) scale(0);
      opacity: 0;
    }
  }

  /* Enhanced loader text for 3D effect */
  .loader-text span {
    display: inline-block;
    transform-style: preserve-3d;
    backface-visibility: hidden;
  }
</style>
